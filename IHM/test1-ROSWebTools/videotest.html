<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #container {
            display: flex;
        }

        #videoContainer {
            margin-right: 20px;
        }
    </style>

    <script type="text/javascript">
        // Connecting to ROS
        // -----------------
        var ros = new ROSLIB.Ros({
            url: 'ws://localhost:9090'
        });

        ros.on('connection', function () {
            console.log('Connected to websocket server.');
        });

        ros.on('error', function (error) {
            console.log('Error connecting to websocket server: ', error);
        });

        ros.on('close', function () {
            console.log('Connection to websocket server closed.');
        });

        // Publishing a Topic
        // ------------------
        var cmdVel = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel',
            messageType: 'geometry_msgs/Twist'
        });

        function move(linear, angular) {
            var twist = new ROSLIB.Message({
                linear: { x: linear },
                angular: { z: angular }
            });
            cmdVel.publish(twist);
        };

        // Subscribing to a Topic
        // ----------------------
        var listener = new ROSLIB.Topic({
            ros: ros,
            name: '/listener',
            messageType: 'std_msgs/String'
        });

        listener.subscribe(function (message) {
            console.log('Received message on ' + listener.name + ': ' + message.data);
            listener.unsubscribe();
        });


        // Lidar 
        // ----------------------

        /* var lidar = new ROSLIB.Topic({
                    ros: ros,
                    name: '/scan',
                    messageType: 'sensor_msgs/LaserScan'
                });*/




        const TOPIC_LIDAR = "scan";


        var lidar_source = null;

        // Test if Server-Source Event is supported
        if (typeof (EventSource) !== "undefined") {
            // the key expression to subscribe
            var key_expr = sub_scope + TOPIC_LIDAR;

            // update Lidar label
            let elem = document.getElementById("lidar_label");
            elem.innerHTML = "Lidar ( " + key_expr + " )";

            // Get canvas context and get its dimensions
            const canvas = document.getElementById('Lidar-canvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Create EventSource for subscription to key_expr
            console.log("Subscribe to EventSource: " + rest_api + key_expr);
            console.log("OLD Lidar EventSource " + lidar_source);
            lidar_source = new EventSource(rest_api + key_expr);
            lidar_source.onmessage = function (e) { console.log("!!!!! ERR: " + e) };
            console.log("NEW Lidar EventSource " + lidar_source.url);
            lidar_source.addEventListener("PUT", function (e) {
                let sample = JSON.parse(e.data);
                // The payload buffer is in "value" field, encoded as base64.
                // Since it's comming from DDS, we decode it using a jscdr.CDRReader.
                let reader = new jscdr.CDRReader(dcodeIO.ByteBuffer.fromBase64(sample.value));
                // Decode the buffer as an LaserScan message
                let scan = LaserScan.decode(reader);

                // Force range_max to 3.5 for consistency between robots
                max_range_displayed = 3.5
                //max_range_displayed = scan.range_max

                // Convert to [x,y, isInRange] points, where:
                //  - if isInRange==true then {x,y} are the relative coordinates computed from {angle,range}
                //  - if isInRange==false then the range was out of range_min/range_max and {x,y} are the relative
                //    coordinate of {angle,LIMIT} where LIMIT is range_max or range_min (the closest bound).
                let angle = -3.1415927410125732;
                let scale = Math.min(canvas.width, canvas.height) / 2 / max_range_displayed;
                let points = [];
                for (const range of scan.ranges) {
                    var r = range;
                    var isInRange = true;
                    if (range > scan.range_max) {
                        r = scan.range_max;
                        isInRange = false;
                    } else if (range < scan.range_min) {
                        r = scan.range_min;
                        isInRange = false;
                    }

                    const x = r * scale * Math.sin(angle);
                    const y = r * scale * Math.cos(angle);
                    points.push([x, y, isInRange]);
                    angle += scan.angle_increment;
                }

                // Clear canvas
                ctx.clearRect(0, 0, width, height);

                // Draw rays
                ctx.lineWidth = 2;
                for (const [x, y, isInRange] of points) {
                    ctx_x = x + width / 2;
                    ctx_y = y + height / 2;
                    ctx.beginPath();
                    if (isInRange) {
                        ctx.strokeStyle = 'LightGray';
                    } else {
                        ctx.strokeStyle = 'Gainsboro';
                    }
                    ctx.moveTo(width / 2, height / 2);
                    ctx.lineTo(ctx_x, ctx_y);
                    ctx.stroke();
                }

                // Draw points
                ctx.fillStyle = 'red';
                for (const [x, y, isInRange] of points) {
                    ctx_x = x + width / 2;
                    ctx_y = y + height / 2;
                    if (isInRange) {
                        ctx.fillRect(ctx_x, ctx_y, 1, 1);
                    }
                }

                // Draw axis lines
                ctx.beginPath();
                ctx.strokeStyle = 'DimGray';
                ctx.lineWidth = 1;
                ctx.moveTo(0, height / 2);
                ctx.lineTo(width, height / 2);
                ctx.moveTo(width / 2, 0);
                ctx.lineTo(width / 2, height);
                ctx.stroke();

            }, false);
        } else {
            document.document.getElementById("Lidar").innerHTML = "Sorry, your browser does not support server-sent events...";
        }






    </script>
</head>

<body>
    <div id="container">
        <div id="videoContainer">
            <img id="videoStream" src="http://localhost:8080/stream?topic=/camera/image_raw" width="640" height="480" />
        </div>

        <div id="commandes">
            <div id="Drive" class="w3-container w3-padding">
                <div class="w3-auto" style="display: grid; width:12em; height:9em;">
                    <button onmousedown="move(1.0, 0.0);" onmouseup="move(0.0, 0.0);" ontouchstart="move(1.0, 0.0);"
                        ontouchend="move(0.0, 0.0);" style='font-size:2em; grid-column: 2; grid-row: 1;'>
                        <i class='fas fa-caret-up'></i>
                    </button>
                    <button onmousedown="move(0.0, 1.0);" onmouseup="move(0.0, 0.0);" ontouchstart="move(0.0, 1.0);"
                        ontouchend="move(0.0, 0.0);" style='font-size:2em; grid-column: 1; grid-row: 2;'>
                        <i class='fas fa-caret-left'></i>
                    </button>
                    <button onmousedown="move(-1.0, 0.0);" onmouseup="move(0.0, 0.0);" ontouchstart="move(-1.0, 0.0);"
                        ontouchend="move(0.0, 0.0);" style='font-size:2em; grid-column: 2; grid-row: 2;'>
                        <i class='fas fa-caret-down'></i>
                    </button>
                    <button onmousedown="move(0.0, -1.0);" onmouseup="move(0.0, 0.0);" ontouchstart="move(0.0, -1.0);"
                        ontouchend="move(0.0, 0.0);" style='font-size:2em; grid-column: 3; grid-row: 2;'>
                        <i class='fas fa-caret-right'></i>
                    </button>
                    <button onclick="move(0.0, 0.0);" style='font-size:2em; grid-column: 1 / 4; grid-row: 3;'>
                        STOP
                    </button>
                </div>
                <br />
            </div>
        </div>
    </div>

    <div class="w3-card-4 w3-margin-bottom">
        <header class="w3-bar w3-green" onclick="document.getElementById('Lidar').classList.toggle('w3-hide');">
            <h5 id="lidar_label" class="w3-bar-item" style="margin: 0;">Lidar</h5>
            <h5 class="w3-bar-item w3-right" style="margin: 0;"><i class='fa fa-line-chart'></i></h5>
        </header>
        <div id="Lidar" class="w3-container w3-padding" style="width: 95%; height: 300px;">
            <canvas id="Lidar-canvas" width="300" height="300"></canvas>
        </div>
        <br />
    </div>

    <script src="script.js"></script>




</body>

</html>